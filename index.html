<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FLASH Video Labeling Tool</title>
    <style>
        :root {
            --bg-color: #f4f4f9;
            --main-color: #ffffff;
            --primary-text: #333;
            --secondary-text: #555;
            --accent-color: #007bff;
            --accent-hover: #0056b3;
            --danger-color: #dc3545;
            --danger-hover: #c82333;
            --success-color: #28a745;
            --border-color: #ddd;
            --shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--primary-text);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container {
            width: 100%;
            max-width: 800px;
            background: var(--main-color);
            padding: 25px;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }
        #progress-container {
            width: 100%;
            background-color: var(--border-color);
            border-radius: 5px;
            margin-bottom: 20px;
            height: 10px;
        }
        #progress-bar {
            width: 0%;
            height: 100%;
            background-color: var(--success-color);
            border-radius: 5px;
            transition: width 0.5s ease-in-out;
        }
        #progress-text {
            text-align: center;
            font-size: 0.9em;
            color: var(--secondary-text);
            margin-bottom: 20px;
        }
        h1, h3 { color: var(--primary-text); border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        video { width: 100%; border-radius: 4px; }
        textarea {
            width: 100%;
            padding: 10px;
            font-size: 1em;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box; /* Important */
            margin-top: 10px;
            resize: vertical;
        }
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        button {
            padding: 12px 20px;
            font-size: 1em;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            color: white;
            transition: background-color 0.2s;
        }
        .btn-mark { background-color: var(--accent-color); }
        .btn-mark:hover { background-color: var(--accent-hover); }
        #submit-btn { background-color: var(--success-color); font-weight: bold; }
        #next-btn { background-color: var(--secondary-text); }
        #delete-btn { background-color: var(--danger-color); }
        #timestamps { margin-top: 20px; background: var(--bg-color); padding: 15px; border-radius: 4px; }
        #timestamps p { margin: 5px 0; font-family: monospace; }
        #status-message { margin-top: 20px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Video Labeling Tool</h1>
        <div id="progress-container"><div id="progress-bar"></div></div>
        <div id="progress-text">Loading progress...</div>

        <video id="video-player" controls></video>
        
        <h3>Caption to Edit</h3>
        <textarea id="caption-input" rows="3"></textarea>
        
        <h3>Mark Timestamps</h3>
        <div class="controls-grid">
            <button class="btn-mark" onclick="markTime('build_up')">Mark Build Up</button>
            <button class="btn-mark" onclick="markTime('peak_start')">Mark Peak Start</button>
            <button class="btn-mark" onclick="markTime('peak_end')">Mark Peak End</button>
            <button class="btn-mark" onclick="markTime('drop_off')">Mark Drop Off</button>
        </div>
        
        <div id="timestamps">
            <p>Build Up: <span id="build_up_time">-</span></p>
            <p>Peak Start: <span id="peak_start_time">-</span></p>
            <p>Peak End: <span id="peak_end_time">-</span></p>
            <p>Drop Off: <span id="drop_off_time">-</span></p>
        </div>
        
        <hr style="margin: 25px 0;">
        
        <div class="controls-grid">
            <button id="submit-btn" onclick="submitLabels()">Submit Labels</button>
            <button id="next-btn" onclick="getNextTask()">Skip & Get Next</button>
            <button id="delete-btn" onclick="deleteTask()">Mark as Bad Quality</button>
        </div>

        <p id="status-message"></p>
    </div>

    <script>
        const videoPlayer = document.getElementById('video-player');
        const captionInput = document.getElementById('caption-input');
        const statusMessage = document.getElementById('status-message');
        
        let currentTask = null;
        let labels = {};

        async function getNextTask() {
            statusMessage.textContent = 'Loading next video...';
            clearUI();
            try {
                const response = await fetch('/get-next-task');
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Server error');
                }
                currentTask = await response.json();
                resetLabels();
                updateUIForNewTask();
                statusMessage.textContent = `Labeling video row_id: ${currentTask.row_id}`;
            } catch (error) {
                statusMessage.textContent = `Error: ${error.message}`;
                videoPlayer.src = '';
            }
        }

        async function submitLabels() {
            if (!currentTask) return alert("No task loaded.");
            if (Object.values(labels).some(v => v < 0)) return alert("Please mark all four timestamps.");

            const submissionData = {
                row_id: currentTask.row_id,
                revised_caption: captionInput.value,
                ...labels
            };

            try {
                const response = await fetch('/submit-labels', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(submissionData)
                });
                const data = await response.json();
                if (data.status === 'success') {
                    statusMessage.textContent = `Submitted row_id: ${data.row_id}. Getting next task...`;
                    await updateProgress();
                    getNextTask();
                } else {
                    throw new Error('Submission failed on server.');
                }
            } catch (error) {
                statusMessage.textContent = `Error: ${error}`;
            }
        }

        async function deleteTask() {
            if (!currentTask) return alert("No task loaded.");
            if (!confirm(`Are you sure you want to mark this video (row_id: ${currentTask.row_id}) as bad quality? This action cannot be undone.`)) {
                return;
            }

            try {
                const response = await fetch(`/delete-task/${currentTask.row_id}`, { method: 'POST' });
                const data = await response.json();
                if (data.status === 'deleted') {
                    statusMessage.textContent = `Marked row_id: ${data.row_id} as bad. Getting next task...`;
                    await updateProgress();
                    getNextTask();
                } else {
                    throw new Error('Deletion failed on server.');
                }
            } catch (error) {
                statusMessage.textContent = `Error: ${error}`;
            }
        }

        async function updateProgress() {
            try {
                const response = await fetch('/get-progress');
                const data = await response.json();
                const percentage = data.total > 0 ? (data.completed / data.total) * 100 : 0;
                document.getElementById('progress-bar').style.width = `${percentage}%`;
                document.getElementById('progress-text').textContent = `${data.completed} / ${data.total} tasks completed (${percentage.toFixed(1)}%)`;
            } catch (error) {
                document.getElementById('progress-text').textContent = 'Could not load progress.';
            }
        }
        
        function markTime(labelType) {
            if (!currentTask) return alert("Please get a task first!");
            const currentTime = videoPlayer.currentTime;
            labels[labelType] = currentTime;
            document.getElementById(`${labelType}_time`).textContent = currentTime.toFixed(3) + 's';
        }

        function resetLabels() {
            labels = { build_up: -1.0, peak_start: -1.0, peak_end: -1.0, drop_off: -1.0 };
        }

        function updateUIForNewTask() {
            console.log("currentTask.video:", currentTask.video);
            const videoFilename = currentTask.video.split('/').pop();
            videoPlayer.src = `/video/${videoFilename}`;
            captionInput.value = currentTask.revised_caption;
            Object.keys(labels).forEach(key => {
                document.getElementById(`${key}_time`).textContent = '-';
            });
        }
        
        function clearUI() {
            currentTask = null;
            captionInput.value = '';
            videoPlayer.src = '';
            resetLabels();
            Object.keys(labels).forEach(key => {
                document.getElementById(`${key}_time`).textContent = '-';
            });
        }

        // Initial load
        window.onload = () => {
            updateProgress();
            getNextTask();
        };
    </script>
</body>
</html>
